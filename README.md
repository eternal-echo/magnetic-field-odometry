# Magnetic-Field aided Inertial Navigation System

This repo implements a magnetic-Field aided inertial navigation system as in paper [A Tightly-Integrated Magnetic-Field aided Inertial
Navigation System](https://www.researchgate.net/publication/360672526_A_Tightly-Integrated_Magnetic-Field_aided_Inertial_Navigation_System). 

## Comparison with a pure standalone INS
Groudtruth             |  Pure INS  | Magnetic-field aided INS
:-------------------------:|:-------------------------:|:-------------------------:
![](./Groundtruth.gif)  |  ![](./MagNoAid.gif) | ![](./MagAid.gif) 




|![](./comparison.png)
|:--:|
| <b>The red line shows the RMSE of the filter estimate, the dashed line shows the RMSE of the filter estimate without magnetic-field aiding.</b>|



## Run simulation
1. create a folder `figures` 
2. run `main.m`

在这个算法中，代码根据时间将整个过程分为前 20 秒和后 40 秒两个阶段，分别采用不同的测量更新策略来进行扩展卡尔曼滤波（EKF）的状态估计。下面我将从数学原理的角度，详细解释这两个阶段的算法流程以及它们之间的差异。

## 总体算法流程

扩展卡尔曼滤波器（EKF）是一种用于非线性系统状态估计的滤波器，包括预测和更新两个步骤：

1. **预测步骤**：根据系统的运动模型，预测下一时刻的状态和协方差矩阵。
2. **更新步骤**：利用新的测量数据，更新状态估计和协方差矩阵。

## 前 20 秒（同时使用位置和磁场测量）

**时间范围：** \( 0 \leq t < 20\,\text{秒} \)

### 1. 测量矩阵构建

在前 20 秒内，系统可以获取到**位置信息**和**磁场测量**，因此测量向量包含了位置和磁场数据。

测量矩阵 \( H \) 构建如下：

\[
H = \begin{bmatrix}
H_{\text{mag}} \\
H_{\text{pos}}
\end{bmatrix}
\]

其中：

- \( H_{\text{mag}} \) 是磁场测量的测量矩阵。
- \( H_{\text{pos}} = \begin{bmatrix} I_{3 \times 3} & 0_{3 \times (n - 3)} \end{bmatrix} \)，表示位置测量只与位置状态相关。

### 2. 测量噪声协方差矩阵

测量噪声协方差矩阵 \( R \) 也是块对角矩阵：

\[
R = \operatorname{diag}(R_{\text{mag}}, R_{\text{pos}})
\]

其中：

- \( R_{\text{mag}} \) 是磁场测量噪声协方差矩阵。
- \( R_{\text{pos}} \) 是位置测量噪声协方差矩阵，假设位置测量噪声为 \( \sigma_{\text{pos}}^2 \)，则 \( R_{\text{pos}} = \sigma_{\text{pos}}^2 \cdot I_{3 \times 3} \)。

### 3. 卡尔曼增益计算

卡尔曼增益 \( K \) 计算公式：

\[
K = P_{k|k-1} H^T (H P_{k|k-1} H^T + R)^{-1}
\]

- \( P_{k|k-1} \) 是预测步骤得到的协方差矩阵。

### 4. 状态更新

测量残差（创新） \( \tilde{z} \) 计算：

\[
\tilde{z} = \begin{bmatrix}
z_{\text{mag}} - h_{\text{mag}}(x_{k|k-1}) \\
z_{\text{pos}} - x_{\text{pos}, k|k-1}
\end{bmatrix}
\]

- \( z_{\text{mag}} \) 是磁场测量值。
- \( h_{\text{mag}}(x_{k|k-1}) \) 是根据当前状态预测的磁场测量值。
- \( z_{\text{pos}} \) 是位置测量值。
- \( x_{\text{pos}, k|k-1} \) 是预测的位置信息。

状态更新：

\[
x_{k|k} = x_{k|k-1} + K \tilde{z}
\]

协方差矩阵更新：

\[
P_{k|k} = (I - K H) P_{k|k-1}
\]

## 后 40 秒（仅使用磁场测量）

**时间范围：** \( t \geq 20\,\text{秒} \)

### 1. 测量矩阵构建

在后 40 秒内，系统只能获取到**磁场测量**，无法获得位置信息，因此测量矩阵只包含磁场测量部分：

\[
H = H_{\text{mag}}
\]

### 2. 测量噪声协方差矩阵

测量噪声协方差矩阵只有磁场测量噪声：

\[
R = R_{\text{mag}}
\]

### 3. 卡尔曼增益计算

卡尔曼增益计算同前，但使用新的 \( H \) 和 \( R \)：

\[
K = P_{k|k-1} H^T (H P_{k|k-1} H^T + R)^{-1}
\]

### 4. 状态更新

测量残差（创新）计算：

\[
\tilde{z} = z_{\text{mag}} - h_{\text{mag}}(x_{k|k-1})
\]

状态和协方差更新同前：

\[
x_{k|k} = x_{k|k-1} + K \tilde{z}
\]
\[
P_{k|k} = (I - K H) P_{k|k-1}
\]

## 不同阶段的数学原理差异

### 1. 测量信息的可用性

- **前 20 秒**：测量向量包含了更多的信息（位置和磁场），这使得状态估计更加准确，滤波器可以同时校正位置和其他状态。
- **后 40 秒**：由于位置信息不可用，滤波器只能利用磁场测量来校正状态，这可能导致估计误差增大，特别是对于无法直接观测到的状态。

### 2. 观测矩阵 \( H \) 的维度变化

- **前 20 秒**：\( H \) 的维度更大，包含了位置测量对应的部分，这意味着测量模型对状态的敏感度更高。
- **后 40 秒**：\( H \) 的维度较小，只有磁场测量部分，观测能力降低。

### 3. 卡尔曼增益 \( K \) 的影响

- **前 20 秒**：由于测量噪声协方差矩阵 \( R \) 中包含了位置测量的低噪声（假设位置测量噪声较小），卡尔曼增益会较大，更加信任测量数据，对状态的校正力度更强。
- **后 40 秒**：缺少位置测量，卡尔曼增益减小，对状态的校正依赖于磁场测量，与系统模型的预测相比，测量对状态更新的影响减弱。

### 4. 状态估计的精度和稳定性

- **前 20 秒**：由于有更多的测量信息，状态估计的精度较高，协方差矩阵中的不确定性随着时间减小。
- **后 40 秒**：缺少位置信息，状态估计的精度可能下降，协方差矩阵中的不确定性可能增大，需要依赖系统模型的准确性。

## 算法流程总结

1. **初始化**：设置初始状态 \( x_0 \) 和协方差矩阵 \( P_0 \)，初始化测量矩阵 \( H \) 和测量噪声协方差矩阵 \( R \)。

2. **时间循环**：对于每个时间步 \( k \)：

   - **预测步骤**：
     - 利用系统模型预测下一时刻的状态 \( x_{k|k-1} \) 和协方差矩阵 \( P_{k|k-1} \)。
   
   - **测量更新**：
     - 根据当前时间 \( t_k \)，判断可用的测量信息：
       - **如果 \( t_k < 20\,\text{秒} \)**：
         - 使用位置和磁场测量，构建相应的 \( H \) 和 \( R \)。
       - **否则**：
         - 仅使用磁场测量，更新 \( H \) 和 \( R \)。
     - 计算卡尔曼增益 \( K \)。
     - 计算测量残差 \( \tilde{z} \)。
     - 更新状态 \( x_{k|k} \) 和协方差矩阵 \( P_{k|k} \)。

3. **循环迭代**：重复上述步骤，直到处理完所有时间步。

## 结论

通过上述分析，可以看出算法在不同时间段内，根据可用的测量信息调整测量模型和滤波器参数，以优化状态估计的精度。在前 20 秒，由于有丰富的测量信息，滤波器能够更准确地校正状态；而在后 40 秒，缺少位置信息，滤波器需要更依赖于系统模型和先验信息。因此，在实际应用中，及时获取准确的测量数据对于滤波器的性能至关重要。


